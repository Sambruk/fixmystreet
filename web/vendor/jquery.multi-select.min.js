(function(d){function g(a,b){this.h=d(a);this.g=d.extend({},k,b);this.S()}var k={containerHTML:'<div class="multi-select-container">',menuHTML:'<div class="multi-select-menu">',buttonHTML:'<span class="multi-select-button">',menuItemsHTML:'<div class="multi-select-menuitems">',menuItemHTML:'<label class="multi-select-menuitem">',presetsHTML:'<div class="multi-select-presets">',modalHTML:void 0,menuItemTitleClass:"multi-select-menuitem--titled",activeClass:"multi-select-container--open",noneText:"-- Select --",
allText:void 0,presets:void 0,positionedMenuClass:"multi-select-container--positioned",positionMenuWithin:void 0,viewportBottomGutter:20,menuMinHeight:200};d.extend(g.prototype,{S:function(){this.I();this.R();this.K();this.J();this.L();this.O();this.T();this.U();this.h.hide()},I:function(){if(!1===this.h.is("select[multiple]"))throw Error("$.multiSelect only works on <select multiple> elements");},R:function(){this.u=d('label[for="'+this.h.attr("id")+'"]')},K:function(){this.j=d(this.g.containerHTML);
this.h.data("multi-select-container",this.j);this.j.insertAfter(this.h)},J:function(){var a=this;this.l=d(this.g.buttonHTML);this.l.attr({role:"button","aria-haspopup":"true",tabindex:0,"aria-label":this.u.eq(0).text()}).on("keydown.multiselect",function(b){var c=b.which;13===c||32===c?(b.preventDefault(),a.l.click()):40===c?(b.preventDefault(),a.B(),(a.o||a.m).children(":first").focus()):27===c&&a.s()}).on("click.multiselect",function(){a.C()}).appendTo(this.j);this.h.on("change.multiselect",function(){a.F()});
this.F()},F:function(){var a=[],b=[];this.h.find("option").each(function(){var c=d(this).text();a.push(c);d(this).is(":selected")&&b.push(d.trim(c))});this.l.empty();0==b.length?this.l.text(this.g.noneText):b.length===a.length&&this.g.allText?this.l.text(this.g.allText):this.l.text(b.join(", "))},L:function(){var a=this;this.i=d(this.g.menuHTML);this.i.attr({role:"menu"}).on("keyup.multiselect",function(b){27===b.which&&(a.s(),a.l.focus())}).appendTo(this.j);this.M();this.g.presets&&this.P()},M:function(){var a=
this;this.m=d(this.g.menuItemsHTML);this.i.append(this.m);this.h.on("change.multiselect",function(b,c){!0!==c&&a.G()});this.G()},G:function(){var a=this;this.m.empty();this.h.children("optgroup,option").each(function(b,c){"OPTION"===c.nodeName?(b=a.A(d(c),b),a.m.append(b)):a.N(d(c),b)})},D:function(a,b){var c=b.which;38===c?(b.preventDefault(),b=d(b.currentTarget).prev(),b.length?b.focus():this.o&&"menuitem"===a?this.o.children(":last").focus():this.l.focus()):40===c&&(b.preventDefault(),b=d(b.currentTarget).next(),
b.length||"menuitem"===a?b.focus():this.m.children(":first").focus())},P:function(){var a=this;this.o=d(this.g.presetsHTML);this.i.prepend(this.o);d.each(this.g.presets,function(b,c){b=a.h.attr("name")+"_preset_"+b;var f=d(a.g.menuItemHTML).attr({"for":b,role:"menuitem"}).text(" "+c.name).on("keydown.multiselect",a.D.bind(a,"preset")).appendTo(a.o);b=d("<input>").attr({type:"radio",name:a.h.attr("name")+"_presets",id:b}).prependTo(f);c.all&&(c.options=[],a.h.find("option").each(function(){var e=d(this).val();
c.options.push(e)}));b.on("change.multiselect",function(){a.h.val(c.options);a.h.trigger("change")})});this.h.on("change.multiselect",function(){a.H()});this.H()},H:function(){var a=this;d.each(this.g.presets,function(b,c){b=a.h.attr("name")+"_preset_"+b;b=a.o.find("#"+b);a:{c=c.options||[];var f=a.h.val()||[];if(c.length!=f.length)c=!1;else{c.sort();f.sort();for(var e=0;e<c.length;e++)if(c[e]!==f[e]){c=!1;break a}c=!0}}c?b.prop("checked",!0):b.prop("checked",!1)})},N:function(a,b){var c=this;a.children("option").each(function(f,
e){e=c.A(d(e),b+"_"+f);var h=c.g.menuItemTitleClass;0!==f&&(h+="sr");e.addClass(h).attr("data-group-title",a.attr("label"));c.m.append(e)})},A:function(a,b){var c=this.h.attr("name")+"_"+b;b=d(this.g.menuItemHTML).attr({"for":c,role:"menuitem"}).on("keydown.multiselect",this.D.bind(this,"menuitem")).text(" "+a.text());c=d("<input>").attr({type:"checkbox",id:c,value:a.val()}).prependTo(b);a.is(":disabled")&&c.attr("disabled","disabled");a.is(":selected")&&c.prop("checked","checked");c.on("change.multiselect",
function(){d(this).prop("checked")?a.prop("selected",!0):a.prop("selected",!1);a.trigger("change",[!0])});return b},O:function(){var a=this;this.g.modalHTML&&(this.v=d(this.g.modalHTML),this.v.on("click.multiselect",function(){a.s()}),this.v.insertBefore(this.i))},T:function(){var a=this;d("html").on("click.multiselect",function(){a.s()});this.j.on("click.multiselect",function(b){b.stopPropagation()})},U:function(){var a=this;this.u.on("click.multiselect",function(b){b.preventDefault();b.stopPropagation();
a.C()})},B:function(){d("html").trigger("click.multiselect");this.j.addClass(this.g.activeClass);if(this.g.positionMenuWithin&&this.g.positionMenuWithin instanceof d){var a=this.i.offset().left+this.i.outerWidth(),b=this.g.positionMenuWithin.offset().left+this.g.positionMenuWithin.outerWidth();a>b&&(this.i.css("width",b-this.i.offset().left),this.j.addClass(this.g.positionedMenuClass))}a=this.i.offset().top+this.i.outerHeight();b=d(window).scrollTop()+d(window).height();a>b-this.g.viewportBottomGutter?
this.i.css({maxHeight:Math.max(b-this.g.viewportBottomGutter-this.i.offset().top,this.g.menuMinHeight),overflow:"scroll"}):this.i.css({maxHeight:"",overflow:""})},s:function(){this.j.removeClass(this.g.activeClass);this.j.removeClass(this.g.positionedMenuClass);this.i.css("width","auto")},C:function(){this.j.hasClass(this.g.activeClass)?this.s():this.B()}});d.fn.multiSelect=function(a){return this.each(function(){d.data(this,"plugin_multiSelect")||d.data(this,"plugin_multiSelect",new g(this,a))})}})(jQuery);
